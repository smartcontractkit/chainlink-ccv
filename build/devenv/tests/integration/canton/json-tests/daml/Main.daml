module Main where

import DA.Crypto.Text (BytesHex, byteCount)
import DA.Text qualified as Text

template TestRouter
  with
    ccipOwner : Party
    partyOwner : Party
  where
    signatory ccipOwner
    observer partyOwner

    nonconsuming choice CCIPSend : CCIPSendResult
      with
        destChainSelector : Numeric 0
        sequenceNumber : Numeric 0
        messageId : BytesHex
        encodedMessage : BytesHex
        verifierBlobs : [BytesHex]
        receipts: [Receipt]
      controller partyOwner
      do
        ccipMessageSentCid <- create CCIPMessageSent with
          ccipOwner = ccipOwner
          sender = partyOwner
          observers = [partyOwner]
          event = CCIPMessageSentEvent with
            destChainSelector = destChainSelector
            sequenceNumber = sequenceNumber
            messageId = messageId
            encodedMessage = encodedMessage
            verifierBlobs = verifierBlobs
            receipts = receipts

        pure CCIPSendResult with
          router = self
          ccipMessageSent = ccipMessageSentCid
          messageId = messageId

-- | Fee/gas accounting for a single entity (CCV, pool, executor, or network).
-- Matches EVM Receipt structure for cross-chain fee transparency.
data Receipt = Receipt
    with
        issuer : Text              -- CCV ID (e.g., "49ff34ed@party"), pool ID, or "network"
        destGasLimit : Int         -- Gas allocated for dest chain execution
        destBytesOverhead : Int    -- Data availability overhead in bytes
        feeTokenAmount : Numeric 0 -- Fee amount in fee token units
        extraArgs : BytesHex       -- Entity-specific arguments
    deriving (Eq, Show)

data CCIPSendResult = CCIPSendResult
    with
        router : ContractId TestRouter
        ccipMessageSent : ContractId CCIPMessageSent
        messageId : BytesHex
    deriving (Eq, Show)

template CCIPMessageSent
    with
        ccipOwner : Party
        sender : Party
        observers : [Party]
        event : CCIPMessageSentEvent
    where
        signatory ccipOwner
        observer sender, observers

data CCIPMessageSentEvent = CCIPMessageSentEvent
    with
        destChainSelector : Numeric 0
        sequenceNumber : Numeric 0
        messageId : BytesHex
        encodedMessage : BytesHex
        verifierBlobs : [BytesHex]
        receipts : [Receipt]
    deriving (Eq, Show)
