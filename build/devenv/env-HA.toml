cl_nodes_funding_eth = 50
cl_nodes_funding_link = 50

[environment_topology]
indexer_address = ["http://indexer-1:8100", "http://indexer-2:8100"]
pyroscope_url = "http://host.docker.internal:4040"

[environment_topology.monitoring]
Enabled = true
Type = "beholder"

[environment_topology.monitoring.Beholder]
InsecureConnection = true
OtelExporterHTTPEndpoint = "host.docker.internal:4318"
LogStreamingEnabled = false
MetricReaderInterval = 5
TraceSampleRatio = 1.0
TraceBatchTimeout = 10

[[environment_topology.nop_topology.nops]]
alias = "default-verifier-1"
name = "default-verifier-1"
mode = "standalone"

[[environment_topology.nop_topology.nops]]
alias = "default-executor-1"
name = "default-executor-1"
mode = "standalone"

# Single committee with TWO aggregators (redundant / HA).
# Both aggregators serve the same 1-of-1 committee: same signing key, same on-chain Verifier contract.
# HA is achieved by running two standalone verifier containers that share the same NOP signing key
# but each write to a different aggregator endpoint.  If one aggregator fails, the other continues
# to produce valid attestations independently (quorum = 1-of-1).
[environment_topology.nop_topology.committees.default]
qualifier = "default"
verifier_version = "1.7.0"

[[environment_topology.nop_topology.committees.default.aggregators]]
name = "default"
address = "default-aggregator:50051"
insecure_connection = true

[[environment_topology.nop_topology.committees.default.aggregators]]
name = "default-ha"
address = "default-ha-aggregator:50051"
insecure_connection = true

[environment_topology.nop_topology.committees.default.chain_configs.3379446385462418246]
nop_aliases = ["default-verifier-1"]
threshold = 1

[environment_topology.nop_topology.committees.default.chain_configs.12922642891491394802]
nop_aliases = ["default-verifier-1"]
threshold = 1

[environment_topology.nop_topology.committees.default.chain_configs.4793464827907405086]
nop_aliases = ["default-verifier-1"]
threshold = 1

[environment_topology.executor_pools.default]
nop_aliases = ["default-executor-1"]
execution_interval = 15_000_000_000

[cldf]

[jd]
  csa_encryption_key = "d1093c0060d50a3c89c189b2e485da5a3ce57f3dcb38ab7e2c0d5f0bb2314a44"
  image = "job-distributor:local"

[[blockchains]]
  container_name = "blockchain-src"
  chain_id = "1337"
  docker_cmd_params = ["-b", "1", "--mixed-mining", "--slots-in-an-epoch", "1"]
  image = "ghcr.io/foundry-rs/foundry:latest"
  port = "8545"
  type = "anvil"

[[blockchains]]
  container_name = "blockchain-dst"
  chain_id = "2337"
  docker_cmd_params = ["-b", "1", "--mixed-mining", "--slots-in-an-epoch", "1"]
  image = "ghcr.io/foundry-rs/foundry:latest"
  port = "8555"
  type = "anvil"

[[blockchains]]
  container_name = "blockchain-3rd"
  chain_id = "3337"
  docker_cmd_params = ["-b", "1", "--mixed-mining", "--slots-in-an-epoch", "1"]
  image = "ghcr.io/foundry-rs/foundry:latest"
  port = "8565"
  type = "anvil"

[fake]
  image = "ccv-fakes:dev"
  port = 9111
  source_code_path = "../build/devenv/fakes"
  root_path = "../../"

[pricer]
  image = "pricer:dev"
  source_code_path = "../pricer"
  root_path = "../../"
  [pricer.keystore]
    address = "0x9221E2E83903C731C2927CCd84e5fa02B22Bb1E2"
    file_path = "../pricer/keystore.json"
    password = "keystore_test_password"

[[verifier]]
  image = "verifier:dev"
  container_name = "default-verifier-1"
  nop_alias = "default-verifier-1"
  port = 8100
  source_code_path = "../verifier"
  root_path = "../../"
  committee_name = "default"
  node_index = 0
  [verifier.db]
    image = "postgres:16-alpine"
    name = "default-verifier-1-db"
    port = 8432

[[verifier]]
  image = "verifier:dev"
  container_name = "default-verifier-2"
  # Same NOP alias as the primary verifier: both containers share the same signing key.
  # node_index = 1 causes this container to write to the second aggregator (default-ha-aggregator)
  # while the primary writes to the first (default-aggregator).
  nop_alias = "default-verifier-1"
  port = 8200
  source_code_path = "../verifier"
  root_path = "../../"
  committee_name = "default"
  node_index = 1
  [verifier.db]
    image = "postgres:16-alpine"
    name = "default-verifier-2-db"
    port = 8433

[[executor]]
  image = "executor:dev"
  port = 8101
  source_code_path = "../executor"
  root_path = "../../"
  container_name = "default-executor-1"
  nop_alias = "default-executor-1"
  executor_qualifier = "default"

[[indexer]]
  image = "indexer:dev"
  port = 8104
  source_code_path = "../indexer"
  root_path = "../../"
  [indexer.db]
    image = "postgres:16-alpine"

[indexer.indexer_config]
LogLevel = 'info'

[indexer.indexer_config.Monitoring]
Enabled = true
Type = 'beholder'

[indexer.indexer_config.Monitoring.Beholder]
InsecureConnection = true
CACertFile = ''
OtelExporterGRPCEndpoint = ''
OtelExporterHTTPEndpoint = 'otel-collector:4318'
LogStreamingEnabled = true
MetricReaderInterval = 5
TraceSampleRatio = 1.0
TraceBatchTimeout = 10

# Discoveries are overwritten by environment.go from aggregator outputs.
# These are placeholders to provide the template structure.
[[indexer.indexer_config.Discoveries]]
Address = "default-aggregator:50051"
Since = 0
PollInterval = 500
Timeout = 5000
NtpServer = "time.google.com"

[[indexer.indexer_config.Discoveries]]
Address = "default-ha-aggregator:50051"
Since = 0
PollInterval = 500
Timeout = 5000
NtpServer = "time.google.com"

[indexer.indexer_config.Scheduler]
TickerInterval = 50
VerificationVisibilityWindow = 28800
BaseDelay = 100
MaxDelay = 30_000

[indexer.indexer_config.Pool]
ConcurrentWorkers = 1000
WorkerTimeout = 300

[[indexer.indexer_config.Verifier]]
Type = "aggregator"
Name = "CommiteeVerifier (Primary)"
Address = "default-aggregator:50051"
InsecureConnection = true
BatchSize = 100
MaxBatchWaitTime = 50
Since = 0

[[indexer.indexer_config.Verifier]]
Type = "aggregator"
Name = "CommiteeVerifier (Primary-HA)"
Address = "default-ha-aggregator:50051"
InsecureConnection = true
BatchSize = 100
MaxBatchWaitTime = 50
Since = 0

[indexer.committee_verifier_name_to_qualifier]
"CommiteeVerifier (Primary)" = "default"
"CommiteeVerifier (Primary-HA)" = "default"

[indexer.indexer_config.Storage]
Strategy = "single"

[indexer.indexer_config.Storage.Single]
Type = "postgres"

[indexer.indexer_config.Storage.Single.Postgres]
MaxOpenConnections = 20
MaxIdleConnections = 5
IdleInTxSessionTimeout = 60
LockTimeout = 30

[indexer.secrets.Storage.Single.Postgres]
URI = "postgresql://indexer:indexer@indexer-db:5432/indexer?sslmode=disable"

[[indexer]]
  image = "indexer:dev"
  port = 8105
  source_code_path = "../indexer"
  root_path = "../../"
  [indexer.db]
    image = "postgres:16-alpine"

[indexer.indexer_config]
LogLevel = 'info'

[indexer.indexer_config.Monitoring]
Enabled = true
Type = 'beholder'

[indexer.indexer_config.Monitoring.Beholder]
InsecureConnection = true
CACertFile = ''
OtelExporterGRPCEndpoint = ''
OtelExporterHTTPEndpoint = 'otel-collector:4318'
LogStreamingEnabled = true
MetricReaderInterval = 5
TraceSampleRatio = 1.0
TraceBatchTimeout = 10

[[indexer.indexer_config.Discoveries]]
Address = "default-aggregator:50051"
Since = 0
PollInterval = 500
Timeout = 5000
NtpServer = "time.google.com"

[[indexer.indexer_config.Discoveries]]
Address = "default-ha-aggregator:50051"
Since = 0
PollInterval = 500
Timeout = 5000
NtpServer = "time.google.com"

[indexer.indexer_config.Scheduler]
TickerInterval = 50
VerificationVisibilityWindow = 28800
BaseDelay = 100
MaxDelay = 30_000

[indexer.indexer_config.Pool]
ConcurrentWorkers = 1000
WorkerTimeout = 300

[[indexer.indexer_config.Verifier]]
Type = "aggregator"
Name = "CommiteeVerifier (Primary)"
Address = "default-aggregator:50051"
InsecureConnection = true
BatchSize = 100
MaxBatchWaitTime = 50
Since = 0

[[indexer.indexer_config.Verifier]]
Type = "aggregator"
Name = "CommiteeVerifier (Primary-HA)"
Address = "default-ha-aggregator:50051"
InsecureConnection = true
BatchSize = 100
MaxBatchWaitTime = 50
Since = 0

[indexer.committee_verifier_name_to_qualifier]
"CommiteeVerifier (Primary)" = "default"
"CommiteeVerifier (Primary-HA)" = "default"

[indexer.indexer_config.Storage]
Strategy = "single"

[indexer.indexer_config.Storage.Single]
Type = "postgres"

[indexer.indexer_config.Storage.Single.Postgres]
MaxOpenConnections = 20
MaxIdleConnections = 5
IdleInTxSessionTimeout = 60
LockTimeout = 30

[indexer.secrets.Storage.Single.Postgres]
URI = "postgresql://indexer-2:indexer-2@indexer-2-db:5432/indexer-2?sslmode=disable"

[[aggregator]]
  name = "default"
  committee_name = "default"
  image = "aggregator:dev"
  host_port = 50051
  source_code_path = "../aggregator"
  root_path = "../../"

  [aggregator.db]
    image = "postgres:16-alpine"
    host_port = 7432

  [aggregator.redis]
    image = "redis:7-alpine"
    host_port = 6379

  [[aggregator.api_clients]]
  client_id = "default-verifier-1"
  description = "Development default verifier 1"
  enabled = true
  groups = ["verifiers"]

  [[aggregator.api_clients]]
  client_id = "default-verifier-2"
  description = "Development default verifier 2"
  enabled = true
  groups = ["verifiers"]

  [[aggregator.api_clients]]
  client_id = "monitoring"
  description = "Monitoring and infrastructure client"
  enabled = true
  groups = ["monitoring"]

  [[aggregator.api_clients]]
  client_id = "indexer"
  description = "Development Indexer"
  enabled = true
  groups = ["indexer"]

  [aggregator.env]
    storage_connection_url = "postgresql://aggregator:aggregator@default-aggregator-db:5432/aggregator?sslmode=disable"
    redis_address = "default-aggregator-redis:6379"
    redis_password = ""
    redis_db = "0"

[[aggregator]]
  name = "default-ha"
  committee_name = "default"
  image = "aggregator:dev"
  host_port = 50054
  source_code_path = "../aggregator"
  root_path = "../../"

  [aggregator.db]
    image = "postgres:16-alpine"
    host_port = 7435

  [aggregator.redis]
    image = "redis:7-alpine"
    host_port = 6382

  [[aggregator.api_clients]]
  client_id = "default-verifier-1"
  description = "Development default verifier 1 (HA)"
  enabled = true
  groups = ["verifiers"]

  [[aggregator.api_clients]]
  client_id = "default-verifier-2"
  description = "Development default verifier 2 (HA)"
  enabled = true
  groups = ["verifiers"]

  [[aggregator.api_clients]]
  client_id = "monitoring"
  description = "Monitoring and infrastructure client"
  enabled = true
  groups = ["monitoring"]

  [[aggregator.api_clients]]
  client_id = "indexer"
  description = "Development Indexer"
  enabled = true
  groups = ["indexer"]

  [aggregator.env]
    storage_connection_url = "postgresql://aggregator:aggregator@default-ha-aggregator-db:5432/aggregator?sslmode=disable"
    redis_address = "default-ha-aggregator-redis:6379"
    redis_password = ""
    redis_db = "0"
