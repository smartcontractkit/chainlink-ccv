set fallback

# Default: show available recipes
default:
    just --list

# Format all go files
fmt:
    golangci-lint fmt

# Run golangci-lint
lint:
    golangci-lint run --output.text.path stdout

mod-tidy:
    go mod tidy

mod-download:
    go mod download

proto:
    protoc --go_out=. --go-grpc_out=. ./proto/aggregator.proto

proto-lint:
    buf lint

proto-check: proto
    @git diff --name-only -- *.pb.go > /tmp/proto_diff_output; \
    if [ -s /tmp/proto_diff_output ]; then \
        echo "Error: Generated protobuf files are out of sync"; \
        echo "Run 'just proto' and commit the changes"; \
        echo "Diff:"; \
        git diff -- *.pb.go; \
        exit 1; \
    else \
        echo "Protobuf files are in sync"; \
    fi

test:
    go test -v ./...

test-coverage:
    go test -v -coverprofile=coverage.out ./...

build:
    docker build -f Dockerfile -t aggregator:latest .

build-dev:
    docker build -f Dockerfile.dev -t aggregator:dev .

clean:
    docker rmi aggregator:latest

clean-dev:
    docker rmi aggregator:dev
