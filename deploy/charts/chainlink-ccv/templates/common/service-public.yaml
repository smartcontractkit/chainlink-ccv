{{- $global := . -}}
{{- range until (include "chainlink-cluster.clusterSize" . | int) }}
  {{- $merged := dict "common" $global.Values.common "overrides" $global.Values.overrides "idx" . | include "chainlink-cluster.merged" | fromYaml -}}
  {{- if and ($global.Values.enabled) ($merged.service.public.enabled) }}
  {{- $nodeName :=  dict "global" $global "merged" $merged "idx" . | include "chainlink-cluster.nodeName" -}}
  {{- $labels := dict "global" $global "merged" $merged "nodeName" $nodeName | include "chainlink-cluster.labelMachine" | fromYaml }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $nodeName }}-pub
  labels: {{ $labels.instance | nindent 4 }}
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: external
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: instance
    external-dns.alpha.kubernetes.io/hostname: {{ printf $merged.service.public.host }}
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/load-balancer-source-ranges: 0.0.0.0/0
spec:
  type: LoadBalancer
  selector: {{ $labels.instanceSelector | nindent 4 }}
  {{- include "chainlink-cluster.publicPorts" $global | nindent 2 }}
{{- end }}
{{- end }}
